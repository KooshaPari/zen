<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zen MCP Stream Viewer</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
      .row { margin-bottom: .75rem; }
      .ok { color: #1b7; }
      .error { color: #d33; }
      pre { background: #f6f8fa; padding: 1rem; border-radius: 6px; overflow: auto; }
      input[type="text"] { width: 320px; padding: .5rem; }
    </style>
  </head>
  <body>
    <h1>Zen MCP Stream Viewer</h1>

    <div class="row">
      <label>Base URL: <input id="base" type="text" value="" placeholder="http://localhost:8080" /></label>
    </div>
    <div class="row">
      <label>Task ID: <input id="task" type="text" placeholder="paste a task id" /></label>
      <button id="watch">Watch</button>
    </div>
    <div class="row">
      <button id="events">Listen to /events/live</button>
    </div>

    <h3>Status</h3>
    <div id="status" class="row">Idle</div>

    <h3>Messages</h3>
    <pre id="log"></pre>

    <script>
      const $ = (id) => document.getElementById(id);
      const log = (msg, cls) => {
        const el = $("log");
        const time = new Date().toISOString();
        el.textContent += `[${time}] ${msg}\n`;
        el.scrollTop = el.scrollHeight;
        if (cls) $("status").className = cls;
      };

      const buildBase = () => {
        let base = $("base").value.trim();
        if (!base) base = window.location.origin;
        return base;
      };

      let currentEventSource = null;
      const closeCurrent = () => { if (currentEventSource) { currentEventSource.close(); currentEventSource = null; } };

      $("watch").onclick = () => {
        closeCurrent();
        const base = buildBase();
        const task = $("task").value.trim();
        if (!task) { log("Please enter a task ID", "error"); return; }
        const url = `${base}/stream/${task}`;
        log(`Connecting to ${url} ...`, "ok");
        const es = new EventSource(url);
        currentEventSource = es;
        es.addEventListener("state", (ev) => log(`state: ${ev.data}`));
        es.addEventListener("done", (ev) => log(`done: ${ev.data}`));
        es.addEventListener("error", (ev) => log(`error: ${ev.data}`, "error"));
        es.onerror = () => log("stream error", "error");
        es.onopen = () => log("connected", "ok");
      };

      $("events").onclick = () => {
        closeCurrent();
        const base = buildBase();
        const url = `${base}/events/live`;
        log(`Listening on ${url} ...`, "ok");
        const es = new EventSource(url);
        currentEventSource = es;
        es.addEventListener("tasks", (ev) => log(`tasks: ${ev.data}`));
        es.onerror = () => log("events error", "error");
        es.onopen = () => log("connected to events", "ok");
      };
    </script>
  </body>
</html>
